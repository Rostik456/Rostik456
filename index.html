<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MC Mobile Build Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; touch-action: none; font-family: sans-serif; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Кнопки керування */
        .touch-btn { position: absolute; background: rgba(0,0,0,0.4); border: 2px solid #fff; border-radius: 10px; pointer-events: auto; display: flex; align-items: center; justify-content: center; color: white; user-select: none; font-size: 14px; }
        #btn-up { bottom: 130px; left: 80px; width: 50px; height: 50px; }
        #btn-down { bottom: 30px; left: 80px; width: 50px; height: 50px; }
        #btn-left { bottom: 80px; left: 30px; width: 50px; height: 50px; }
        #btn-right { bottom: 80px; left: 130px; width: 50px; height: 50px; }
        
        /* Дії */
        #btn-jump { bottom: 30px; right: 30px; width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.3); }
        #btn-action { bottom: 120px; right: 30px; width: 70px; height: 70px; border-radius: 10px; background: #4caf50; font-weight: bold; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; width: 12px; height: 12px; border: 2px solid white; transform: translate(-50%, -50%); border-radius: 50%; }
        #msg { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: white; background: rgba(0,0,0,0.5); padding: 5px; font-size: 12px; border-radius: 5px; }
    </style>
</head>
<body>

<div id="msg">Тап по блоку — зламати | Кнопка BUILD — поставити</div>
<div id="ui-layer">
    <div id="crosshair"></div>
    <div class="touch-btn" id="btn-up">W</div>
    <div class="touch-btn" id="btn-down">S</div>
    <div class="touch-btn" id="btn-left">A</div>
    <div class="touch-btn" id="btn-right">D</div>
    <div class="touch-btn" id="btn-jump">JUMP</div>
    <div class="touch-btn" id="btn-action">BUILD</div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, yawObj, pitchObj, raycaster;
    let move = { f: 0, b: 0, l: 0, r: 0 };
    let velY = 0, canJump = false;
    let objects = [];
    let lastTouchX = 0, lastTouchY = 0;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        pitchObj = new THREE.Object3D();
        pitchObj.add(camera);
        yawObj = new THREE.Object3D();
        yawObj.add(pitchObj);
        yawObj.position.set(10, 5, 10);
        scene.add(yawObj);

        renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        raycaster = new THREE.Raycaster();

        // Початковий світ
        for(let x=0; x<15; x++) {
            for(let z=0; z<15; z++) {
                createBlock(x, 0, z, 0x5d8233);
            }
        }

        // Керування рухом
        const setupBtn = (id, key) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); move[key] = 1; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); move[key] = 0; });
        };
        setupBtn('btn-up', 'f'); setupBtn('btn-down', 'b');
        setupBtn('btn-left', 'l'); setupBtn('btn-right', 'r');
        
        document.getElementById('btn-jump').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(canJump) { velY = 0.2; canJump = false; }
        });

        // КНОПКА BUILD (СТАВИТИ БЛОК)
        document.getElementById('btn-action').addEventListener('touchstart', (e) => {
            e.preventDefault();
            interact(true); // true = ставити
        });

        // ТАП ПО ЕКРАНУ (ЛАМАТИ БЛОК АБО ОБЕРТАТИ)
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'CANVAS') {
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
                
                // Якщо це швидкий тап по центру — ламаємо блок
                setTimeout(() => interact(false), 50); 
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (e.touches[0].clientX > window.innerWidth / 3) { // Обертання в правій частині
                const touch = e.touches[0];
                const movementX = touch.clientX - lastTouchX;
                const movementY = touch.clientY - lastTouchY;
                yawObj.rotation.y -= movementX * 0.007;
                pitchObj.rotation.x -= movementY * 0.007;
                pitchObj.rotation.x = Math.max(-1.5, Math.min(1.5, pitchObj.rotation.x));
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
            }
        });

        loop();
    }

    function createBlock(x, y, z, color = 0x795548) {
        const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshLambertMaterial({color: color}));
        cube.position.set(Math.floor(x), Math.floor(y), Math.floor(z));
        scene.add(cube);
        objects.push(cube);
    }

    function interact(isPlace) {
        raycaster.setFromCamera({x: 0, y: 0}, camera);
        const hits = raycaster.intersectObjects(objects);
        if (hits.length > 0 && hits[0].distance < 5) {
            if (isPlace) {
                // Ставимо блок на сторону, куди дивимось
                const pos = hits[0].object.position.clone().add(hits[0].face.normal);
                createBlock(pos.x, pos.y, pos.z);
            } else {
                // Видаляємо блок
                scene.remove(hits[0].object);
                objects = objects.filter(obj => obj !== hits[0].object);
            }
        }
    }

    function loop() {
        requestAnimationFrame(loop);
        let oldPos = yawObj.position.clone();
        velY -= 0.01;
        
        let dir = new THREE.Vector3(move.r - move.l, 0, move.b - move.f);
        dir.applyQuaternion(yawObj.quaternion).normalize().multiplyScalar(0.1);
        
        yawObj.position.x += dir.x;
        yawObj.position.z += dir.z;
        yawObj.position.y += velY;

        // Колізія підлоги
        if(yawObj.position.y < 2) {
            yawObj.position.y = 2;
            velY = 0;
            canJump = true;
        }

        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>







