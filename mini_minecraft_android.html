<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Minecraft Mobile Save System</title>
<style>
body{margin:0;overflow:hidden;background:#000;touch-action:none;font-family:sans-serif}
canvas{width:100%;height:100%;display:none} /* Сховано до старту */

/* МЕНЮ */
#menu{position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)), url('https://wallpaperaccess.com/full/465600.jpg');background-size:cover;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;gap:20px}
#menu h1{color:white;text-shadow:4px 4px #000;font-size:40px;margin-bottom:30px}
.m-btn{pointer-events:auto;width:250px;padding:15px;background:#5d8233;border:4px solid #3a5220;color:white;font-weight:bold;font-size:18px;text-align:center;text-shadow:2px 2px #000;cursor:pointer}
.m-btn:active{background:#4a6929}

/* UI ГРИ */
#ui{position:absolute;inset:0;pointer-events:none;z-index:10;display:none}
.btn{pointer-events:auto;color:#fff;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);border:2px solid #fff;border-radius:10px;position:absolute;width:60px;height:60px;user-select:none}
#u{bottom:140px;left:80px} #d{bottom:20px;left:80px} #l{bottom:80px;left:10px} #r{bottom:80px;left:150px}
.act{position:absolute;width:75px;height:75px;border-radius:50%;background:rgba(255,255,255,0.2);border:2px solid #fff;pointer-events:auto;color:#fff;font-weight:bold}
#jmp{bottom:20px;right:110px} #put{bottom:110px;right:25px;background:rgba(76,175,80,.8)} #del{bottom:20px;right:25px;background:rgba(244,67,54,.8)}
#inv{position:absolute;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px;background:rgba(0,0,0,.6);padding:6px;border-radius:8px;pointer-events:auto}
.slot{width:35px;height:35px;border:2px solid #555;background-size:cover}
.slot.active{border-color:#fff;box-shadow:0 0 10px #fff}
#fs-toggle{position:absolute;top:10px;right:10px;padding:12px;background:rgba(0,0,0,0.7);color:#fff;border:2px solid #fff;border-radius:8px;pointer-events:auto;font-size:12px}
#save-anim{position:absolute;top:60px;right:10px;color:#fff;background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:5px;display:none}
</style>
</head>
<body>

<div id="menu">
    <h1>MINECRAFT</h1>
    <div class="m-btn" onclick="startGame(false)">НОВА ГРА</div>
    <div class="m-btn" onclick="startGame(true)">ПРОДОВЖИТИ</div>
</div>

<div id="ui">
    <div id="fs-toggle" onclick="toggleFS()">FULLSCREEN</div>
    <div id="save-anim">Saving...</div>
    <div id="inv">
        <div class="slot active" id="s1" onclick="sel(1,event)"></div>
        <div class="slot" id="s8" onclick="sel(8,event)"></div>
        <div class="slot" id="s9" onclick="sel(9,event)"></div> 
        <div class="slot" id="s3" onclick="sel(3,event)"></div>
        <div class="slot" id="s4" onclick="sel(4,event)"></div>
    </div>
    <div class="btn" id="u">▲</div><div class="btn" id="d">▼</div>
    <div class="btn" id="l">◀</div><div class="btn" id="r">▶</div>
    <button class="act" id="jmp">JMP</button>
    <button class="act" id="put">PUT</button>
    <button class="act" id="del">DEL</button>
</div>

<script type="importmap">
{"imports":{"three":"https://unpkg.com/three@0.160.0/build/three.module.js"}}
</script>

<script type="module">
import * as THREE from "three";

let scene, camera, renderer, yaw, pitch, ray;
let move = {f:0, b:0, l:0, r:0}, vel = 0, canJ = false, blocks = [], selected = 1;
const texs = {};

window.toggleFS = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

function mkTex(c1, c2, pattern='noise') {
    const can = document.createElement('canvas'); can.width = 16; can.height = 16;
    const ctx = can.getContext('2d');
    ctx.fillStyle = c1; ctx.fillRect(0,0,16,16);
    ctx.fillStyle = c2;
    if(pattern === 'planks') { ctx.fillRect(0, 7, 16, 2); ctx.fillRect(7, 0, 2, 7); }
    else if (pattern === 'brick') { for (let y = 0; y < 16; y += 4) ctx.fillRect(0, y, 16, 1); for (let x = 0; x < 16; x += 8) ctx.fillRect(x, 0, 1, 16); }
    else { for(let i=0; i<32; i++) ctx.fillRect(Math.random()*16, Math.random()*16, 1, 1); }
    const t = new THREE.CanvasTexture(can); t.magFilter = THREE.NearestFilter; return t;
}

window.startGame = (loadExisting) => {
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.querySelector('canvas').style.display = 'block';
    init(loadExisting);
}

function init(loadExisting) {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 25, 75);

    texs[1] = mkTex('#5d8233', '#4a6929');
    texs[2] = mkTex('#795548', '#5d4037');
    texs[3] = mkTex('#808080', '#606060');
    texs[4] = mkTex('#6d4c41', '#4e342e');
    texs[5] = mkTex('#1e88e5', '#1565c0');
    texs[6] = mkTex('#2e7d32', '#1b5e20');
    texs[7] = mkTex('#202020', '#000000');
    texs[8] = mkTex('#bc986a', '#967342', 'planks');
    texs[9] = mkTex('#b53f3f', '#8c2f2f', 'brick');

    [1, 8, 9, 3, 4].forEach(id => document.getElementById('s'+id).style.backgroundImage = `url(${texs[id].image.toDataURL()})`);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    pitch = new THREE.Object3D(); pitch.add(camera);
    yaw = new THREE.Object3D(); yaw.add(pitch);
    scene.add(yaw);

    renderer = new THREE.WebGLRenderer({antialias: false});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 1.4));
    ray = new THREE.Raycaster();

    if (loadExisting && localStorage.getItem('mc_save')) {
        loadWorld();
    } else {
        yaw.position.set(20, 10, 20);
        createWorld();
    }

    // УПРАВЛІННЯ
    const b = (id, k) => {
        const el = document.getElementById(id);
        el.onpointerdown = (e) => { e.stopPropagation(); move[k] = 1; };
        el.onpointerup = (e) => { move[k] = 0; };
        el.onpointerleave = () => { move[k] = 0; };
    };
    b("u","f"); b("d","b"); b("l","l"); b("r","r");

    document.getElementById("jmp").onpointerdown = (e) => { if(canJ) vel = 0.22; e.stopPropagation(); };
    document.getElementById("put").onpointerdown = (e) => { interact(true); e.stopPropagation(); };
    document.getElementById("del").onpointerdown = (e) => { interact(false); e.stopPropagation(); };

    let lx, ly, touchID = null;
    renderer.domElement.addEventListener("pointerdown", e => { if (touchID === null) { touchID = e.pointerId; lx = e.clientX; ly = e.clientY; }});
    renderer.domElement.addEventListener("pointermove", e => {
        if (e.pointerId === touchID) {
            yaw.rotation.y -= (e.clientX - lx) * 0.004;
            pitch.rotation.x -= (e.clientY - ly) * 0.004;
            pitch.rotation.x = Math.max(-1.5, Math.min(1.5, pitch.rotation.x));
            lx = e.clientX; ly = e.clientY;
        }
    });
    renderer.domElement.addEventListener("pointerup", () => touchID = null);

    setInterval(saveWorld, 5000); // Автозбереження кожні 5 сек
    loop();
}

function addB(x, y, z, t) {
    const mat = new THREE.MeshLambertMaterial({map: texs[t],







