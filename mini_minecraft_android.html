<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minecraft Mobile Final Fix</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #87ceeb; touch-action: none; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* Кнопки ходьби - фіксований розмір */
        .joy { position: absolute; bottom: 30px; left: 30px; width: 180px; height: 180px; pointer-events: auto; }
        .b { position: absolute; width: 55px; height: 55px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; }
        #u { top: 0; left: 60px; }
        #d { bottom: 0; left: 60px; }
        #l { top: 60px; left: 0; }
        #r { top: 60px; right: 0; }

        /* Кнопки дій */
        .actions { position: absolute; bottom: 30px; right: 30px; pointer-events: auto; display: flex; flex-direction: column; gap: 10px; }
        .a { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        #jump { background: rgba(255,255,255,0.2); }
        #put { background: rgba(76, 175, 80, 0.8); }
        #del { background: rgba(244, 67, 54, 0.8); }

        /* Інвентар */
        #inv { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 10px; }
        .slot { width: 40px; height: 40px; border: 2px solid #555; background-size: cover; }
        .slot.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
    </style>
</head>
<body>

<div id="ui">
    <div id="inv">
        <div class="slot active" id="s1" onclick="window.setB(1)"></div>
        <div class="slot" id="s4" onclick="window.setB(4)"></div>
        <div class="slot" id="s6" onclick="window.setB(6)"></div>
        <div class="slot" id="s3" onclick="window.setB(3)"></div>
        <div class="slot" id="s5" onclick="window.setB(5)"></div>
    </div>
    <div class="joy">
        <div class="b" id="u">▲</div><div class="b" id="l">◀</div>
        <div class="b" id="r">▶</div><div class="b" id="d">▼</div>
    </div>
    <div class="actions">
        <div class="a" id="put">PUT</div>
        <div class="a" id="jump">JUMP</div>
        <div class="a" id="del">DEL</div>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, yaw, pitch, ray;
    let move = { f:0, b:0, l:0, r:0 };
    let vel = new THREE.Vector3();
    let objects = [];
    let selB = 1, lastTX = 0, lastTY = 0;
    const texs = {};

    function mkTex(c1, c2) {
        const can = document.createElement('canvas'); can.width = 16; can.height = 16;
        const ctx = can.getContext('2d');
        ctx.fillStyle = c1; ctx.fillRect(0,0,16,16);
        ctx.fillStyle = c2; for(let i=0; i<20; i++) ctx.fillRect(Math.random()*16, Math.random()*16, 2, 2);
        const t = new THREE.CanvasTexture(can); t.magFilter = THREE.NearestFilter; return t;
    }

    try {
        init();
    } catch (e) {
        alert("Помилка запуску: " + e.message);
    }

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        
        texs[1] = mkTex('#5d8233', '#4d6d2a'); texs[2] = mkTex('#795548', '#614126');
        texs[3] = mkTex('#808080', '#696969'); texs[4] = mkTex('#614126', '#4e341e');
        texs[5] = mkTex('#1e88e5', '#1976d2'); texs[6] = mkTex('#2e7d32', '#1b5e20');

        [1, 4, 6, 3, 5].forEach(id => {
            document.getElementById('s'+id).style.backgroundImage = `url(${texs[id].image.toDataURL()})`;
        });

        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        pitch = new THREE.Object3D(); pitch.add(camera);
        yaw = new THREE.Object3D(); yaw.add(pitch);
        yaw.position.set(5, 5, 5); scene.add(yaw);

        renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        ray = new THREE.Raycaster();

        // Світ
        for(let x=0; x<20; x++) {
            for(let z=0; z<20; z++) {
                addB(x, 0, z, 1);
                if(Math.random() > 0.97) { addB(x, 1, z, 4); addB(x, 2, z, 6); }
            }
        }

        const setup = (id, k) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); move[k] = 1; }, {passive: false});
            el.addEventListener('touchend', (e) => { e.preventDefault(); move[k] = 0; }, {passive: false});
        };
        setup('u', 'f'); setup('d', 'b'); setup('l', 'l'); setup('r', 'r');

        document.getElementById('jump').addEventListener('touchstart', e => { e.preventDefault(); vel.y = 0.2; }, {passive: false});
        document.getElementById('put').addEventListener('touchstart', e => { e.preventDefault(); interact(true); }, {passive: false});
        document.getElementById('del').addEventListener('touchstart', e => { e.preventDefault(); interact(false); }, {passive: false});

        document.addEventListener('touchstart', e => { 
            if(e.touches[0].clientX > window.innerWidth / 2) {
                lastTX = e.touches[0].clientX; lastTY = e.touches[0].clientY; 
            }
        }, {passive: false});
        document.addEventListener('touchmove', e => {
            if(e.target.className.includes('b') || e.target.className.includes('a')) return;
            yaw.rotation.y -= (e.touches[0].clientX - lastTX) * 0.007;
            pitch.rotation.x -= (e.touches[0].clientY - lastTY) * 0.007;
            pitch.rotation.x = Math.max(-1.5, Math.min(1.5, pitch.rotation.x));
            lastTX = e.touches[0].clientX; lastTY = e.touches[0].clientY;
        }, { passive: false });

        window.setB = (id) => { selB = id; document.querySelectorAll('.slot').forEach(s => s.classList.remove('active')); document.getElementById('s'+id).classList.add('active'); };
        
        loop();
    }

    function addB(x, y, z, t) {
        const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshLambertMaterial({map: texs[t]}));
        m.position.set(x, y, z); scene.add(m); objects.push(m);
    }

    function interact(p) {
        ray.setFromCamera({x:0, y:0}, camera);
        const h = ray.intersectObjects(objects);
        if(h.length > 0 && h[0].distance < 5) {
            if(p) { const pos = h[0].object.position.clone().add(h[0].face.normal); addB(pos.x, pos.y, pos.z, selB); }
            else { if(h[0].object.position.y > 0) { scene.remove(h[0].object); objects = objects.filter(o => o !== h[0].object); } }
        }
    }

    function loop() {
        requestAnimationFrame(loop);
        vel.y -= 0.01; yaw.position.y += vel.y;
        if(yaw.position.y < 1.8) { yaw.position.y = 1.8; vel.y = 0; }
        const speed = 0.12;
        const forward = new THREE.Vector3(0,0,-1).applyQuaternion(yaw.quaternion);
        const right = new THREE.Vector3(1,0,0).applyQuaternion(yaw.quaternion);
        if(move.f) yaw.position.add(forward.multiplyScalar(speed));
        if(move.b) yaw.position.add(forward.multiplyScalar(-speed));
        if(move.l) yaw.position.add(right.multiplyScalar(-speed));
        if(move.r) yaw.position.add(right.multiplyScalar(speed));
        renderer.render(scene, camera);
    }
</script>
</body>
</html>






